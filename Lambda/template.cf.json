{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Resources": {
        "IncomingBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "NotificationConfiguration": {
                    "LambdaConfigurations": [
                        {
                            "Function": {"Fn::GetAtt": [ "WatchIncomingLambda", "Arn"  ] },
                            "Event": "s3:ObjectCreated:*"
                        }
                    ]
                }
            },
            "DependsOn": [
                "WatchIncomingLambda"
            ]
        },
        "PrivateBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "AccessControl": "Private"
            }
        },
        "PublicBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "AccessControl": "PublicRead"
            }
        },
        "StatusTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "AttributeDefinitions" : [
                    {"AttributeName" : "idvv", "AttributeType" : "S"}
                ],
                "KeySchema": [
                    {
                        "AttributeName": "idvv",
                        "KeyType": "HASH"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": "5",
                    "WriteCapacityUnits": "5"
                }
            }
        },
        "StatusEventSourceMapping" : {
            "Type" : "AWS::Lambda::EventSourceMapping",
            "Properties" : {
                "Description" : "The source of truth for the processing status of the papers.",
                "EventSourceArn" : {"Fn::GetAtt" : ["StatusTable", "StreamArn"]},
                "FunctionName" : {"Fn::GetAtt" : ["WatchStatusLambda", "Arn"]},
                "BatchSize" : 100,
                "StartingPosition" : "TRIM_HORIZON"
            },
            "DependsOn": [
                "WatchStatusLambda",
                "StatusTable"
            ]
        },
        "WatchStatusLambda":{        
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description": "Watches changes to the database and determines if it is possible to perform any processing on the papers.",
                "Code": "./infrastructure",
                "Environment": {
                    "Variables": {
                        "StatusTable": {"Fn::GetAtt" : ["StatusTable", "Arn"]},
                        "ProcessWrapperLambda" : {"Fn::GetAtt" : ["ProcessWrapperLambda", "Arn"]},
                        "MakeThumbLambda" : {"Fn::GetAtt" : ["MakeThumbLambda", "Arn"]},
                        "IncomingBucket" : {"Fn::GetAtt" : ["IncomingBucket", "Arn"]},
                        "PublicBucket" : {"Fn::GetAtt" : ["PublicBucket", "Arn"]}
                    }
                },
                "MemorySize": 128,
                "Handler": "out/index.WatchStatusLambda",
                "Role": "arn:aws:iam::822003976223:role/service-role/lambda_basic_execution",
                "Timeout": 3,
                "Runtime": "nodejs6.10"
            }
        },
        "WatchIncomingLambda":{        
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description": "Watches additions to the IncomingBucket and updates the corresponding entry on StatusTable.",
                "Code": "./infrastructure",
                "Environment": {
                    "Variables": {
                        "StatusTable": {"Fn::GetAtt" : ["StatusTable", "Arn"]}
                    }
                },
                "MemorySize": 128,
                "Handler": "out/index.WatchIncomingLambda",
                "Role": "arn:aws:iam::822003976223:role/service-role/lambda_basic_execution",
                "Timeout": 3,
                "Runtime": "nodejs6.10"
            }
        },
        "ProcessWrapperLambda":{        
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description": "Wraps a processor lambda and updates the table after it executes.",
                "Code": "./infrastructure",
                "Environment": {
                    "Variables": {
                        "StatusTable": {"Fn::GetAtt" : ["StatusTable", "Arn"]}
                    }
                },
                "MemorySize": 128,
                "Handler": "out/index.ProcessWrapperLambda",
                "Role": "arn:aws:iam::822003976223:role/service-role/lambda_basic_execution",
                "Timeout": 3,
                "Runtime": "nodejs6.10"
            }
        },

        "MakeThumbLambda":{        
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description": "Makes a thumbnail given a pdf using imagemagick", 
                "Code": "./processors/MakeThumbLambda",
                "MemorySize": 128,
                "Handler": "index.handler",
                "Role": "arn:aws:iam::822003976223:role/service-role/lambda_basic_execution",
                "Timeout": 90,
                "Runtime": "nodejs6.10"
            }
        }
    }
}